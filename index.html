<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alert Setup Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #faf9f6;
    --surface: #ffffff;
    --border: #e8e4dc;
    --border2: #d4cfc5;
    --accent: #1a1a2e;
    --accent2: #4f46e5;
    --green: #059669;
    --red: #dc2626;
    --amber: #d97706;
    --text: #1a1a2e;
    --muted: #8b8580;
    --bubble-user: #1a1a2e;
    --tag: #f0ede8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: rgba(250,249,246,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex; align-items: center; justify-content: space-between;
  }

  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 32px; height: 32px;
    background: var(--accent); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; font-size: 16px;
  }
  .logo-text { font-family: 'Instrument Serif', serif; font-size: 18px; color: var(--accent); }

  .status-pill {
    display: flex; align-items: center; gap: 6px;
    background: #ecfdf5; border: 1px solid #a7f3d0;
    border-radius: 100px; padding: 5px 12px;
    font-size: 12px; color: var(--green); font-weight: 500;
  }
  .status-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }

  /* Security banner */
  .security-bar {
    background: #fffbeb;
    border-bottom: 1px solid #fde68a;
    padding: 10px 24px;
    display: flex; align-items: center; gap: 10px;
    font-size: 12px; color: #92400e;
    position: relative; z-index: 99;
  }
  .security-bar strong { color: #78350f; }
  .lock-icon { font-size: 14px; flex-shrink: 0; }

  .main {
    flex: 1; display: flex; flex-direction: column;
    max-width: 720px; margin: 0 auto; width: 100%;
    padding: 0 16px; position: relative; z-index: 1;
  }

  .chat-area {
    flex: 1; padding: 32px 0 140px;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* Welcome */
  .welcome { text-align: center; padding: 40px 24px 28px; animation: fadeUp 0.6s ease both; }
  .welcome-avatar {
    width: 56px; height: 56px; background: var(--accent); border-radius: 18px;
    margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 26px;
  }
  .welcome h2 { font-family: 'Instrument Serif', serif; font-size: 28px; color: var(--accent); margin-bottom: 10px; line-height: 1.2; }
  .welcome p { color: var(--muted); font-size: 15px; line-height: 1.6; max-width: 420px; margin: 0 auto 24px; }

  .security-note {
    background: #f0fdf4; border: 1px solid #bbf7d0;
    border-radius: 12px; padding: 12px 16px;
    font-size: 12px; color: #166534; line-height: 1.6;
    max-width: 460px; margin: 0 auto 24px; text-align: left;
    display: flex; gap: 10px; align-items: flex-start;
  }
  .security-note .shield { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  .quick-starts { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
  .qs-btn {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 100px; padding: 8px 16px; font-size: 13px;
    font-family: 'DM Sans', sans-serif; cursor: pointer; color: var(--text);
    transition: all 0.2s; font-weight: 500;
  }
  .qs-btn:hover { border-color: var(--accent2); color: var(--accent2); background: #f5f3ff; }

  /* Messages */
  .message { display: flex; gap: 12px; animation: fadeUp 0.4s ease both; }
  .message.user { flex-direction: row-reverse; }

  .avatar {
    width: 32px; height: 32px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; flex-shrink: 0; margin-top: 2px;
  }
  .avatar.ai { background: var(--accent); color: white; }
  .avatar.user { background: var(--accent2); color: white; }

  .bubble {
    max-width: 82%; padding: 14px 18px;
    border-radius: 18px; font-size: 14px; line-height: 1.65;
  }
  .message.ai .bubble {
    background: var(--surface); border: 1px solid var(--border);
    border-bottom-left-radius: 4px; color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }
  .message.user .bubble { background: var(--bubble-user); color: white; border-bottom-right-radius: 4px; }
  .bubble strong { font-weight: 600; }
  .bubble code {
    background: rgba(79,70,229,0.08); color: var(--accent2);
    padding: 2px 6px; border-radius: 4px;
    font-family: 'DM Mono', monospace; font-size: 12px;
  }
  .message.user .bubble code { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.9); }

  /* Chips */
  .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
  .chip {
    background: var(--tag); border: 1px solid var(--border2);
    border-radius: 100px; padding: 7px 14px; font-size: 13px;
    cursor: pointer; transition: all 0.15s;
    font-family: 'DM Sans', sans-serif; color: var(--text); font-weight: 500;
  }
  .chip:hover { background: var(--accent2); border-color: var(--accent2); color: white; transform: translateY(-1px); }

  /* Progress tracker */
  .progress-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 16px 20px;
    font-size: 13px; margin-bottom: 4px;
  }
  .progress-title { font-weight: 600; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px; }
  .progress-items { display: flex; flex-direction: column; gap: 8px; }
  .progress-item { display: flex; align-items: center; gap: 10px; font-size: 13px; }
  .progress-item .pi-icon { width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
  .pi-done { background: #ecfdf5; color: var(--green); }
  .pi-pending { background: var(--tag); color: var(--muted); }
  .pi-active { background: #eff6ff; color: var(--accent2); animation: pulse 2s infinite; }
  .progress-item .pi-label { color: var(--text); }
  .progress-item .pi-label.pending { color: var(--muted); }

  /* Typing */
  .typing { display: flex; gap: 12px; animation: fadeUp 0.3s ease both; }
  .typing-dots {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; border-bottom-left-radius: 4px;
    padding: 14px 18px; display: flex; gap: 4px; align-items: center;
  }
  .typing-dots span { width: 6px; height: 6px; background: var(--muted); border-radius: 50%; animation: bounce 1.2s infinite; }
  .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.3s; }

  /* Credential warning */
  .cred-warning {
    background: #fff7ed; border: 1px solid #fed7aa;
    border-radius: 14px; padding: 16px 20px;
    font-size: 13px; color: #9a3412; line-height: 1.6;
  }
  .cred-warning strong { color: #7c2d12; }
  .cred-warning ul { margin: 8px 0 0 16px; }
  .cred-warning li { margin-bottom: 4px; }

  /* Output card */
  .output-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
  .output-tab-bar { display: flex; border-bottom: 1px solid var(--border); background: var(--tag); overflow-x: auto; }
  .output-tab {
    padding: 10px 16px; font-size: 12px; font-family: 'DM Mono', monospace;
    cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent;
    transition: all 0.2s; font-weight: 500; white-space: nowrap;
  }
  .output-tab.active { color: var(--accent2); border-bottom-color: var(--accent2); background: white; }
  .output-content { display: none; padding: 20px; }
  .output-content.active { display: block; }
  .code-pre {
    background: #0f0f1a; border-radius: 10px; padding: 16px;
    font-family: 'DM Mono', monospace; font-size: 12px; line-height: 1.7;
    color: #c8d3f5; overflow-x: auto; max-height: 280px; overflow-y: auto; white-space: pre;
  }
  .copy-row { display: flex; justify-content: flex-end; margin-top: 10px; }
  .copy-btn {
    background: var(--tag); border: 1px solid var(--border2); border-radius: 8px;
    padding: 6px 14px; font-size: 12px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; color: var(--text); transition: all 0.2s; font-weight: 500;
  }
  .copy-btn:hover { background: var(--accent2); color: white; border-color: var(--accent2); }
  .copy-btn.copied { background: var(--green); color: white; border-color: var(--green); }

  /* Summary card */
  .summary-card {
    background: #f5f3ff; border: 1px solid #ddd6fe;
    border-radius: 12px; padding: 16px 18px; margin-bottom: 16px; font-size: 13px;
  }
  .summary-card h4 { font-size: 12px; font-weight: 600; color: var(--accent2); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px; }
  .summary-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #ede9fe; }
  .summary-row:last-child { border-bottom: none; }
  .summary-label { color: var(--muted); }
  .summary-value { font-weight: 600; color: var(--accent); }

  .deploy-steps { display: flex; flex-direction: column; gap: 14px; }
  .deploy-step { display: flex; gap: 12px; align-items: flex-start; }
  .step-num {
    width: 24px; height: 24px; background: var(--accent2); color: white;
    border-radius: 7px; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0; margin-top: 1px;
  }
  .step-text { font-size: 13px; line-height: 1.6; color: var(--text); }
  .step-text code {
    background: rgba(79,70,229,0.08); color: var(--accent2);
    padding: 1px 5px; border-radius: 4px;
    font-family: 'DM Mono', monospace; font-size: 11px;
  }

  /* Input area */
  .input-area {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(250,249,246,0.97); backdrop-filter: blur(16px);
    border-top: 1px solid var(--border); padding: 14px 16px; z-index: 50;
  }
  .input-inner { max-width: 720px; margin: 0 auto; display: flex; gap: 10px; align-items: flex-end; }
  .input-box {
    flex: 1; background: var(--surface); border: 1.5px solid var(--border2);
    border-radius: 16px; padding: 12px 16px;
    font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text);
    resize: none; outline: none; transition: border-color 0.2s;
    min-height: 48px; max-height: 120px; line-height: 1.5;
  }
  .input-box:focus { border-color: var(--accent2); }
  .input-box::placeholder { color: var(--muted); }
  .send-btn {
    width: 48px; height: 48px; background: var(--accent); border: none;
    border-radius: 14px; cursor: pointer; display: flex; align-items: center;
    justify-content: center; transition: all 0.2s; flex-shrink: 0; color: white; font-size: 18px;
  }
  .send-btn:hover { background: var(--accent2); transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<div class="topbar">
  <div class="logo">
    <div class="logo-icon">üîî</div>
    <span class="logo-text">Alert Agent</span>
  </div>
  <div class="status-pill"><div class="status-dot"></div>AI Ready</div>
</div>

<div class="security-bar">
  <span class="lock-icon">üîí</span>
  <span><strong>Your credentials are safe.</strong> Nothing you enter here is stored or sent to any server. Everything stays in your browser and is only used to generate configuration files for you to deploy yourself.</span>
</div>

<div class="main">
  <div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
      <div class="welcome-avatar">ü§ñ</div>
      <h2>Set up your balance alert<br>in plain English.</h2>
      <p>Tell me which service you use. I'll ask simple questions and build everything for you ‚Äî no technical knowledge needed.</p>

      <div class="security-note">
        <span class="shield">üõ°Ô∏è</span>
        <div><strong>100% private & secure.</strong> Your API keys and tokens never leave your browser. This tool only generates files ‚Äî you deploy them yourself. No data is collected, stored, or transmitted.</div>
      </div>

      <div class="quick-starts">
        <button class="qs-btn" onclick="quickStart('Exotel')">üìû Exotel</button>
        <button class="qs-btn" onclick="quickStart('Twilio')">üí¨ Twilio</button>
        <button class="qs-btn" onclick="quickStart('Razorpay')">üí≥ Razorpay</button>
        <button class="qs-btn" onclick="quickStart('AWS')">‚òÅÔ∏è AWS Credits</button>
        <button class="qs-btn" onclick="quickStart('SendGrid')">üìß SendGrid</button>
        <button class="qs-btn" onclick="quickStart('something else')">üîß Other service</button>
      </div>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-inner">
    <textarea class="input-box" id="userInput" placeholder="Type your message or pick a service above..." rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Collected data tracker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let collected = {
  service: null,
  credentials: {},   // key: secret_name, value: actual_value
  threshold: null,
  rechargeAmount: null,
  checkIntervalHours: null,
  slackWebhook: null,
  slackChannel: null
};

const REQUIRED_FIELDS = ['service','threshold','rechargeAmount','checkIntervalHours','slackWebhook'];

const SERVICE_CONFIGS = {
  exotel:    { apiUrl: 'https://api.exotel.com/v1/Accounts/{SID}/balance.json', jsonPath: 'Balance.AvailableBalance', authType: 'basic', auth1Name: 'EXOTEL_API_KEY',       auth2Name: 'EXOTEL_API_TOKEN',    currency: '‚Çπ',   wfName: 'exotel-monitor' },
  twilio:    { apiUrl: 'https://api.twilio.com/2010-04-01/Accounts/{SID}/Balance.json', jsonPath: 'balance', authType: 'basic', auth1Name: 'TWILIO_ACCOUNT_SID', auth2Name: 'TWILIO_AUTH_TOKEN',   currency: 'USD', wfName: 'twilio-monitor' },
  razorpay:  { apiUrl: 'https://api.razorpay.com/v1/balance', jsonPath: 'balance', authType: 'basic', auth1Name: 'RAZORPAY_KEY_ID',   auth2Name: 'RAZORPAY_KEY_SECRET', currency: '‚Çπ',   wfName: 'razorpay-monitor' },
  sendgrid:  { apiUrl: 'https://api.sendgrid.com/v3/user/credits', jsonPath: 'remain', authType: 'bearer', auth1Name: 'SENDGRID_API_KEY', auth2Name: null, currency: 'credits', wfName: 'sendgrid-monitor' },
  aws:       { apiUrl: 'custom', jsonPath: 'credits', authType: 'aws', auth1Name: 'AWS_ACCESS_KEY_ID', auth2Name: 'AWS_SECRET_ACCESS_KEY', currency: 'USD', wfName: 'aws-monitor' },
};

const SYSTEM_PROMPT = `You are a warm, friendly assistant helping non-technical team members set up automated Slack balance alerts. Your job is to guide them through a conversation ‚Äî one question at a time.

CRITICAL SECURITY RULE: NEVER ask for or collect actual API key values, token values, or any credential values. Your company policy strictly prohibits transmitting secrets through any channel. Instead, you only need to know WHICH service they use ‚Äî you already know the correct secret names for each service. Guide users to note their credentials down locally; they will enter them directly into their own .env file themselves.

You must collect ALL of the following (in roughly this order):
1. Which service (Exotel, Twilio, Razorpay, SendGrid, AWS, or custom)
2. Confirm they have located their credentials ‚Äî guide them WHERE to find them, but tell them: "You don't need to share these with me ‚Äî just make sure you have them open and ready. You'll enter them directly into your own .env file."
   - Exotel: my.exotel.com ‚Üí Settings ‚Üí API ‚Üí Account SID, API Key, API Token
   - Twilio: console.twilio.com ‚Üí homepage Account Info panel ‚Üí Account SID, Auth Token
   - Razorpay: dashboard.razorpay.com ‚Üí Settings ‚Üí API Keys ‚Üí Key ID and Key Secret
   - SendGrid: app.sendgrid.com ‚Üí Settings ‚Üí API Keys ‚Üí create one if needed
   - AWS: AWS Console ‚Üí IAM ‚Üí Your user ‚Üí Security credentials ‚Üí Access keys
3. Alert threshold amount ‚Äî ask "At what balance should we send you a warning?"
4. Recharge amount ‚Äî ask "When you get the alert, how much do you usually recharge by? I'll include this as a reminder in the Slack message." Accept any number.
5. Check frequency ‚Äî ask "How often should I check your balance? Just type a number and I'll treat it as hours. For example type 4 for every 4 hours." Accept any number, treat as hours.
6. Slack webhook URL ‚Äî guide them: api.slack.com/apps ‚Üí Create New App ‚Üí Incoming Webhooks ‚Üí toggle ON ‚Üí Add New Webhook ‚Üí pick channel ‚Üí copy URL. The webhook URL is not a secret in the same way (it's posted to Slack's servers), but still remind them to keep it private.
7. Which Slack channel (for confirmation only)

Rules:
- Ask ONLY ONE question at a time.
- NEVER ask "what is your API key?" or "can you share your token?" ‚Äî instead say "Have you got your credentials screen open? You'll paste them into your .env file in a moment."
- Be warm and encouraging.
- For the check frequency: "Just type a number ‚Äî I'll treat it as hours."
- For recharge amount: "What amount do you typically top up by? I'll add this as a reminder in the Slack message."

IMPORTANT ‚Äî Credential Confirmation (NOT collection):
- Do NOT output GENERATE_CONFIG until the user has confirmed they have their credentials ready.
- If they try to skip, say: "I want to make sure your alert works ‚Äî please have your credentials ready so you can fill in the .env file in the next step. You won't need to share them with me!"
- Credentials needed per service (confirm user HAS them, don't ask for values):
  - Exotel: API Key + API Token + Account SID
  - Twilio: Account SID + Auth Token
  - Razorpay: Key ID + Key Secret
  - SendGrid: API Key
  - AWS: Access Key ID + Secret Access Key

When you have collected EVERYTHING (service confirmed, credentials confirmed as ready, threshold, rechargeAmount, checkIntervalHours, slackWebhook, slackChannel), output this at the END of your message:

GENERATE_CONFIG:{"service":"exotel","serviceName":"Exotel","currency":"‚Çπ","apiUrl":"https://api.exotel.com/v1/Accounts/{SID}/balance.json","jsonPath":"Balance.AvailableBalance","authType":"basic","auth1Name":"EXOTEL_API_KEY","auth2Name":"EXOTEL_API_TOKEN","slackWebhook":"https://hooks.slack.com/...","slackChannel":"#channel","threshold":"1000","rechargeAmount":"5000","checkIntervalHours":"4","workflowName":"exotel-monitor"}

IMPORTANT: The JSON must NEVER contain auth1Value or auth2Value fields with real credentials. Only include secret names (auth1Name, auth2Name). The cron will be calculated from checkIntervalHours.`;

let conversationHistory = [];
let isLoading = false;

function quickStart(service) {
  document.getElementById('welcome').style.display = 'none';
  addUserMessage(`I want to set up alerts for ${service}`);
  callAI(`I want to set up alerts for ${service}`);
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || isLoading) return;
  document.getElementById('welcome').style.display = 'none';
  input.value = ''; input.style.height = 'auto';
  addUserMessage(text);
  callAI(text);
}

function addUserMessage(text) {
  const chat = document.getElementById('chatArea');
  const msg = document.createElement('div');
  msg.className = 'message user';
  msg.innerHTML = `<div class="avatar user">U</div><div class="bubble">${escapeHtml(text)}</div>`;
  chat.appendChild(msg);
  scrollBottom();
}

function addAIMessage(text, chips = []) {
  removeTyping();
  const chat = document.getElementById('chatArea');
  const msg = document.createElement('div');
  msg.className = 'message ai';
  let chipsHtml = chips.length > 0
    ? `<div class="chips">${chips.map(c => `<div class="chip" onclick="chipClick('${escapeHtml(c)}')">${escapeHtml(c)}</div>`).join('')}</div>`
    : '';
  msg.innerHTML = `<div class="avatar ai">ü§ñ</div><div class="bubble">${formatText(text)}${chipsHtml}</div>`;
  chat.appendChild(msg);
  scrollBottom();
}

function chipClick(text) {
  document.getElementById('userInput').value = text;
  sendMessage();
}

function showTyping() {
  const chat = document.getElementById('chatArea');
  const t = document.createElement('div');
  t.className = 'typing'; t.id = 'typingIndicator';
  t.innerHTML = `<div class="avatar ai">ü§ñ</div><div class="typing-dots"><span></span><span></span><span></span></div>`;
  chat.appendChild(t);
  scrollBottom();
}

function removeTyping() {
  const t = document.getElementById('typingIndicator');
  if (t) t.remove();
}

function scrollBottom() {
  setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 50);
}

function escapeHtml(text) {
  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatText(text) {
  return escapeHtml(text)
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>');
}

function hoursToCron(hours) {
  const h = parseInt(hours);
  if (h === 1) return '0 * * * *';
  if (h === 24) return '0 9 * * *';
  if (h >= 24) return `0 */${Math.min(h,23)} * * *`;
  return `0 */${h} * * *`;
}

// Redact any webhook URLs or anything that looks like a secret from history
// before sending back to the API ‚Äî policy: never transmit secrets to third parties
function redactForHistory(text) {
  return text
    .replace(/https:\/\/hooks\.slack\.com\/services\/[^\s"']+/gi, '[SLACK_WEBHOOK_REDACTED]')
    .replace(/(xox[bpars]-[A-Za-z0-9\-]+)/gi, '[SLACK_TOKEN_REDACTED]')
    .replace(/\b(sk-[A-Za-z0-9]{20,})/g, '[API_KEY_REDACTED]')
    .replace(/\b(AKIA[A-Z0-9]{16})\b/g, '[AWS_KEY_REDACTED]')
    .replace(/\b(ghp_[A-Za-z0-9]{36})\b/g, '[GH_TOKEN_REDACTED]')
    .replace(/\b([A-Za-z0-9]{32,})\b/g, (match, p1, offset, str) => {
      // Only redact if assigned to a sensitive-looking variable name nearby
      const context = str.substring(Math.max(0, offset-30), offset).toLowerCase();
      if (/key|token|secret|password|credential|auth/.test(context)) return '[SECRET_REDACTED]';
      return match;
    });
}

async function callAI(userMessage) {
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;
  showTyping();

  // Store original for display; redact before sending to API
  conversationHistory.push({ role: 'user', content: redactForHistory(userMessage) });

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: SYSTEM_PROMPT,
        messages: conversationHistory
      })
    });

    const data = await response.json();
    const fullText = data.content[0].text;

    if (fullText.includes('GENERATE_CONFIG:')) {
      const parts = fullText.split('GENERATE_CONFIG:');
      const convo = parts[0].trim();
      const jsonStr = parts[1].trim();
      if (convo) addAIMessage(convo);
      try {
        const config = JSON.parse(jsonStr);
        const missing = validateConfig(config);
        if (missing.length > 0) {
          addAIMessage(`Before I generate your setup, I need a few more things:\n\n${missing.map(m => `‚Ä¢ ${m}`).join('\n')}\n\nLet's make sure everything is ready so your alert works perfectly! üòä`);
        } else {
          generateOutput(config);
        }
      } catch(e) {
        addAIMessage("Almost there! Let me just confirm a couple of details before generating...");
        console.error('Config parse error (no sensitive data):', e.message); // never log jsonStr
      }
    } else {
      const chips = extractChips(fullText);
      addAIMessage(fullText, chips);
    }

    // Redact AI response before storing in history too (AI may echo back webhook URL)
    conversationHistory.push({ role: 'assistant', content: redactForHistory(fullText) });
  } catch (err) {
    removeTyping();
    addAIMessage("Sorry, I had a hiccup. Please try again!");
    console.error('API error (no sensitive data):', err.message); // never log full err object
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
}

function validateConfig(config) {
  const missing = [];
  if (!config.service) missing.push('Service name');
  if (!config.threshold) missing.push('Alert threshold amount');
  if (!config.rechargeAmount) missing.push('Recharge amount (how much you top up)');
  if (!config.checkIntervalHours) missing.push('Check frequency (in hours)');
  if (!config.slackWebhook || !config.slackWebhook.startsWith('https://hooks.slack.com')) missing.push('Valid Slack webhook URL');
  if (!config.auth1Name) missing.push('Service credential name (API Key name)');
  return missing;
}

function extractChips(text) {
  const lower = text.toLowerCase();
  if (lower.includes('how often') || lower.includes('frequency') || lower.includes('type a number') || lower.includes('hours')) {
    return ['1', '2', '4', '8'];
  }
  if (lower.includes('threshold') || lower.includes('low balance') || lower.includes('warning') || lower.includes('below')) {
    return ['500', '1000', '2000', '5000'];
  }
  if (lower.includes('recharge') || lower.includes('top up') || lower.includes('typically')) {
    return ['1000', '2000', '5000', '10000'];
  }
  return [];
}

function generateOutput(config) {
  const hours = parseInt(config.checkIntervalHours) || 4;
  const cron = hoursToCron(hours);
  const wfName = (config.workflowName || 'balance-monitor').replace(/[^a-z0-9-]/g,'');
  const currency = config.currency || '‚Çπ';
  const rechargeAmt = config.rechargeAmount || '5000';

  // Build auth parts
  let authImport = config.authType === 'basic' ? 'from requests.auth import HTTPBasicAuth\n' : '';
  let authEnv = '';
  let requestCode = '';
  if (config.authType === 'basic') {
    authEnv = `API_KEY   = _require("${config.auth1Name}")\nAPI_TOKEN = _require("${config.auth2Name}")`;
    requestCode = `resp = requests.get(API_URL, auth=HTTPBasicAuth(API_KEY, API_TOKEN), timeout=15)`;
  } else if (config.authType === 'bearer') {
    authEnv = `API_KEY = _require("${config.auth1Name}")`;
    requestCode = `resp = requests.get(API_URL, headers={"Authorization": f"Bearer {API_KEY}"}, timeout=15)`;
  } else {
    requestCode = `resp = requests.get(API_URL, timeout=15)`;
  }

  const pathParts = (config.jsonPath || 'balance').split('.');
  const pathCode = pathParts.length === 1
    ? `data.get('${pathParts[0]}', 0)`
    : `data.get('${pathParts[0]}', {}).get('${pathParts[1]}', 0)`;

  const pyScript =
`#!/usr/bin/env python3
"""${config.serviceName} Balance Monitor ‚Äî auto-generated by Alert Agent"""
import os, sys, requests
from dotenv import load_dotenv
${authImport}
# ‚îÄ‚îÄ Load credentials from centralised .env (company security policy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# NEVER move credentials into the project folder or hardcode them here.
load_dotenv(r'C:\\credentials\\.env')

# Fail loudly if any required key is missing ‚Äî do not fall back to defaults
def _require(key):
    val = os.getenv(key)
    if not val:
        raise EnvironmentError(
            f"Missing required key '{key}' in C:\\\\credentials\\\\.env ‚Äî "
            f"please add it and try again."
        )
    return val

API_URL    = "${config.apiUrl}"
${authEnv}
SLACK_URL  = _require("SLACK_WEBHOOK_URL")
THRESHOLD  = float(os.getenv("BALANCE_THRESHOLD", "${config.threshold}"))
RECHARGE   = "${rechargeAmt}"   # Suggested recharge amount

def get_balance():
    ${requestCode}
    resp.raise_for_status()
    data = resp.json()
    return float(${pathCode})

def send_alert(balance):
    requests.post(SLACK_URL, json={"blocks": [
        {"type": "header", "text": {"type": "plain_text",
            "text": "‚ö†Ô∏è  ${config.serviceName} ‚Äî Low Balance Alert!"}},
        {"type": "section", "fields": [
            {"type": "mrkdwn", "text": f"*Current Balance:*\\n${currency}{'{balance:.2f}'}"},
            {"type": "mrkdwn", "text": f"*Alert Threshold:*\\n${currency}${config.threshold}"}
        ]},
        {"type": "section", "fields": [
            {"type": "mrkdwn", "text": f"*Suggested Recharge:*\\n${currency}{RECHARGE}"},
            {"type": "mrkdwn", "text": f"*Checked every:*\\n${hours} hour(s)"}
        ]},
        {"type": "section", "text": {"type": "mrkdwn",
            "text": ":rotating_light: Recharge now to avoid service disruption on in-app calls."}}
    ]}, timeout=10).raise_for_status()
    print(f"‚úÖ Slack alert sent to ${config.slackChannel}. Balance: ${currency}{'{balance:.2f}'}") 

def main():
    balance = get_balance()
    print(f"Balance: ${currency}{'{balance:.2f}'} | Threshold: ${currency}${config.threshold}")
    if balance < THRESHOLD:
        send_alert(balance)
        sys.exit(1)   # Non-zero exit marks run as attention-needed in GitHub
    else:
        print("‚úÖ Balance is healthy. No alert needed.")

if __name__ == "__main__":
    main()`;

  // Build secrets lines for YAML
  let secretLines = `          SLACK_WEBHOOK_URL: \${{ secrets.SLACK_WEBHOOK_URL }}\n          BALANCE_THRESHOLD: "${config.threshold}"`;
  if (config.auth1Name) secretLines = `          ${config.auth1Name}: \${{ secrets.${config.auth1Name} }}\n` + secretLines;
  if (config.auth2Name) secretLines = `          ${config.auth2Name}: \${{ secrets.${config.auth2Name} }}\n` + secretLines;

  const yamlScript =
`name: ${config.serviceName} Balance Monitor

on:
  schedule:
    - cron: '${cron}'   # Every ${hours} hour(s)
  workflow_dispatch:      # Allow manual trigger anytime

jobs:
  check-balance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests==2.32.3 python-dotenv==1.0.1

      - name: Check ${config.serviceName} Balance
        env:
${secretLines}
        run: python check_balance.py`;

  // Secrets list for deploy tab ‚Äî names only, never values
  const secretsList = [];
  if (config.auth1Name) secretsList.push(config.auth1Name);
  if (config.auth2Name) secretsList.push(config.auth2Name);
  secretsList.push('SLACK_WEBHOOK_URL');

  const secretsHtml = secretsList.map(name =>
    `<div class="deploy-step">
      <div class="step-num">‚òÖ</div>
      <div class="step-text">Secret name: <code>${escapeHtml(name)}</code> ‚Äî value from <code>C:\\credentials\\.env</code></div>
    </div>`
  ).join('');

  const chat = document.getElementById('chatArea');

  // ‚îÄ‚îÄ Success message ‚îÄ‚îÄ
  const successMsg = document.createElement('div');
  successMsg.className = 'message ai';
  successMsg.innerHTML = `
    <div class="avatar ai">ü§ñ</div>
    <div class="bubble">
      üéâ <strong>You're all set!</strong> I've generated your personalised alert setup below.<br><br>
      Your credentials were only used to generate these files and are <strong>not stored anywhere</strong>. Follow the 4 steps in the Deploy tab to go live in ~5 minutes!
    </div>`;
  chat.appendChild(successMsg);

  // ‚îÄ‚îÄ Output card ‚îÄ‚îÄ
  const uid = 'oc' + Date.now();
  const card = document.createElement('div');
  card.style.cssText = 'animation: fadeUp 0.5s 0.1s ease both; opacity:0;';
  card.innerHTML = `
    <div class="output-card">
      <div class="output-tab-bar">
        <div class="output-tab active" onclick="switchTab(this,'${uid}-py')">üìÑ check_balance.py</div>
        <div class="output-tab" onclick="switchTab(this,'${uid}-yml')">‚öôÔ∏è workflow.yml</div>
        <div class="output-tab" onclick="switchTab(this,'${uid}-deploy')">üöÄ Deploy Steps</div>
      </div>

      <div id="${uid}-py" class="output-content active">
        <pre class="code-pre" id="${uid}-pycode">${escapeHtml(pyScript)}</pre>
        <div class="copy-row"><button class="copy-btn" onclick="copyEl('${uid}-pycode',this)">Copy file</button></div>
      </div>

      <div id="${uid}-yml" class="output-content">
        <pre class="code-pre" id="${uid}-ymlcode">${escapeHtml(yamlScript)}</pre>
        <div class="copy-row"><button class="copy-btn" onclick="copyEl('${uid}-ymlcode',this)">Copy file</button></div>
      </div>

      <div id="${uid}-deploy" class="output-content">
        <div class="summary-card">
          <h4>Your Configuration</h4>
          <div class="summary-row"><span class="summary-label">Service</span><span class="summary-value">${escapeHtml(config.serviceName)}</span></div>
          <div class="summary-row"><span class="summary-label">Alert threshold</span><span class="summary-value">${currency}${escapeHtml(config.threshold)}</span></div>
          <div class="summary-row"><span class="summary-label">Suggested recharge</span><span class="summary-value">${currency}${escapeHtml(rechargeAmt)}</span></div>
          <div class="summary-row"><span class="summary-label">Check every</span><span class="summary-value">${hours} hour(s)</span></div>
          <div class="summary-row"><span class="summary-label">Slack channel</span><span class="summary-value">${escapeHtml(config.slackChannel || 'configured')}</span></div>
        </div>
        <div class="deploy-steps">
          <div class="deploy-step"><div class="step-num">1</div><div class="step-text">Create a <strong>private GitHub repo</strong> (e.g. <code>${wfName}</code>) at github.com/new</div></div>
          <div class="deploy-step"><div class="step-num">2</div><div class="step-text">üîí Create a <code>.gitignore</code> file in the repo root with these lines to prevent accidental credential exposure:<br><code style="display:block;margin-top:6px;white-space:pre;background:#f0ede8;padding:8px;border-radius:6px;font-size:11px">.env
.env.*
*.env
credentials/</code></div></div>
          <div class="deploy-step"><div class="step-num">3</div><div class="step-text">Upload <code>check_balance.py</code> to the <strong>root</strong> of the repo</div></div>
          <div class="deploy-step"><div class="step-num">4</div><div class="step-text">Create file <code>.github/workflows/${wfName}.yml</code> and paste the workflow YAML</div></div>
          <div class="deploy-step"><div class="step-num">5</div>
            <div class="step-text">Go to <strong>Settings ‚Üí Secrets ‚Üí Actions</strong> and add these secrets. Copy each value from your <code>C:\\credentials\\.env</code> file ‚Äî do <strong>not</strong> paste them anywhere else:
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">${secretsHtml}</div>
            </div>
          </div>
          <div class="deploy-step"><div class="step-num">6</div><div class="step-text">‚ö†Ô∏è <strong>Before any commit</strong>, verify no <code>.env</code> or credential files are staged ‚Äî run <code>git status</code> and check carefully.</div></div>
          <div class="deploy-step"><div class="step-num">7</div><div class="step-text">Go to <strong>Actions tab ‚Üí Run workflow</strong> to test. Check your Slack! üéâ</div></div>
        </div>
      </div>
    </div>`;
  chat.appendChild(card);
  setTimeout(() => { card.style.opacity = '1'; }, 50);
  scrollBottom();
}

function switchTab(el, tabId) {
  const card = el.closest('.output-card');
  card.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
  card.querySelectorAll('.output-content').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function copyEl(id, btn) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = '‚úì Copied!'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy file'; btn.classList.remove('copied'); }, 2000);
  });
}
</script>
</body>
</html>
